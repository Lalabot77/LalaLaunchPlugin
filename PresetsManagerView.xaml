<UserControl x:Class="LaunchPlugin.PresetsManagerView"
             x:Name="Root"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:styles="clr-namespace:SimHub.Plugins.Styles;assembly=SimHub.Plugins"
             xmlns:ui="clr-namespace:SimHub.Plugins.UI;assembly=SimHub.Plugins"
             xmlns:local="clr-namespace:LaunchPlugin"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800">

    <!-- Resources -->
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:BooleanToTextConverter x:Key="BooleanToText" TrueText="Laps" FalseText="Litres"/>
        <local:EnumEqualsConverter x:Key="EnumEqualsConverter"/>
        <local:NotBoolConverter x:Key="NotBoolConverter"/>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250" MinWidth="200"/>
            <ColumnDefinition Width="10"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- LEFT: header + list + full-width New/Delete -->
        <DockPanel Grid.Column="0">
            <TextBlock DockPanel.Dock="Top"
             Text="Race Presets"
             FontSize="16" FontWeight="Bold"
             Margin="0,0,0,10"
             ToolTip="Manage reusable race strategy presets."/>

            <StackPanel DockPanel.Dock="Bottom" Margin="0,10,0,0">
                <styles:SHButtonPrimary Content="Create New Preset"
                            Height="30"
                            Click="OnCreateNewPreset"
                            Background="#28A745" Foreground="White"
                            HorizontalAlignment="Stretch" Margin="0,0,0,6"
                            ToolTip="Create a new preset with default values."/>
                <styles:SHButtonSecondary Content="Delete Current Preset"
                              Height="30"
                              Click="OnDeletePreset"
                              Background="#C82333" Foreground="White"
                              HorizontalAlignment="Stretch"
                              ToolTip="Delete the selected preset from disk."/>
            </StackPanel>

            <ListBox ItemsSource="{Binding AvailablePresets}"
                 SelectedItem="{Binding EditorSelection, ElementName=Root, Mode=TwoWay}"
                 DisplayMemberPath="Name"
                 BorderThickness="1" BorderBrush="Gray"
                 ToolTip="Select a preset to edit."/>
        </DockPanel>

        <!-- RIGHT: split into scrollable editor (row 0) and sticky footer (row 1) -->
        <Grid Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Overlay hint shown only when no selection -->
            <TextBlock Grid.Row="0"
             Text="Select a preset from the list, or click &quot;Create New Preset&quot;."
             FontStyle="Italic"
             Foreground="#AAA"
             HorizontalAlignment="Center"
             VerticalAlignment="Center">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding EditorSelection, ElementName=Root}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <!-- Scrollable editor; disabled when no selection -->
            <ScrollViewer Grid.Row="0"
                VerticalScrollBarVisibility="Auto"
                HorizontalScrollBarVisibility="Disabled">
                <StackPanel x:Name="EditorPanel"
                Margin="10,28,10,10"
                DataContext="{Binding EditingPreset, ElementName=Root}">
                    <StackPanel.Style>
                        <Style TargetType="StackPanel">
                            <Setter Property="IsEnabled" Value="True"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding EditorSelection, ElementName=Root}" Value="{x:Null}">
                                    <Setter Property="IsEnabled" Value="False"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </StackPanel.Style>

                    <!-- Name -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="140"/>
                            <ColumnDefinition Width="260"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Preset Name:" VerticalAlignment="Center" FontWeight="Bold"/>
                        <TextBox Grid.Column="1"
                     Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     ToolTip="Name shown in the preset list."/>
                        <TextBlock Grid.Column="2"
                                   Text="{Binding ActivePresetHelperText, ElementName=Root}"
                                   VerticalAlignment="Center"
                                   FontStyle="Italic"
                                   Foreground="#888">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontStyle" Value="Italic"/>
                                    <Setter Property="Foreground" Value="#888"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEditingActivePreset, ElementName=Root}" Value="True">
                                            <Setter Property="FontStyle" Value="Normal"/>
                                            <Setter Property="FontWeight" Value="Bold"/>
                                            <Setter Property="Foreground" Value="#28A745"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>

                    <!-- Race Type -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <TextBlock Text="Race Type:" VerticalAlignment="Center" Margin="0,0,10,0"
                                   ToolTip="Choose whether the race is limited by laps or time."/>
                        <RadioButton Content="Lap-Limited"
                         IsChecked="{Binding EditingPreset.Type, ElementName=Root,
                                             Converter={StaticResource EnumEqualsConverter},
                                             ConverterParameter=LapLimited, Mode=TwoWay}"
                         GroupName="RaceType"
                         ToolTip="Plan for a fixed number of laps."/>
                        <RadioButton Content="Time-Limited" Margin="10,0,0,0"
                         IsChecked="{Binding EditingPreset.Type, ElementName=Root,
                                             Converter={StaticResource EnumEqualsConverter},
                                             ConverterParameter=TimeLimited, Mode=TwoWay}"
                         GroupName="RaceType"
                         ToolTip="Plan for a fixed race duration (minutes)."/>
                    </StackPanel>

                    <!-- Race Minutes (only when Time-Limited) -->
                    <ui:TitledSlider Title="Race Minutes:"
                           Minimum="1" Maximum="1440"
                           Value="{Binding RaceMinutes, Mode=TwoWay}"
                           ToolTip="Total race duration in minutes.">
                        <ui:TitledSlider.Style>
                            <Style TargetType="{x:Type ui:TitledSlider}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding EditingPreset.Type, ElementName=Root,
                                                 Converter={StaticResource EnumEqualsConverter},
                                                 ConverterParameter=TimeLimited}"
                               Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ui:TitledSlider.Style>
                    </ui:TitledSlider>

                    <!-- Race Laps (only when Lap-Limited) -->
                    <ui:TitledSlider Title="Race Laps:"
                           Minimum="1" Maximum="1000"
                           Value="{Binding RaceLaps, Mode=TwoWay}"
                           ToolTip="Total race distance in laps.">
                        <ui:TitledSlider.Style>
                            <Style TargetType="{x:Type ui:TitledSlider}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding EditingPreset.Type, ElementName=Root,
                                                 Converter={StaticResource EnumEqualsConverter},
                                                 ConverterParameter=LapLimited}"
                               Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ui:TitledSlider.Style>
                    </ui:TitledSlider>

                    <!-- Pit Strategy -->
                    <StackPanel Orientation="Horizontal" Margin="0,10,0,6">
                        <TextBlock Text="Pit Strategy" FontWeight="Bold" VerticalAlignment="Center"/>
                        <CheckBox Content="Mandatory pit stop required"
                      Margin="16,0,0,0"
                      VerticalAlignment="Center"
                      IsChecked="{Binding MandatoryStopRequired, Mode=TwoWay}"
                      ToolTip="Include at least one pit stop in the plan."/>
                    </StackPanel>

                    <!-- Tyre Change Time (s) -->
                    <ui:TitledSlider Title="Tyre Change Time (s):"
                           Minimum="0" Maximum="60"
                           Value="{Binding TireChangeTimeSec, Mode=TwoWay}"
                           ToolTip="Additional stop time when changing tyres (sec)."/>

                    <!-- Max Fuel Override (percent) -->
                    <ui:TitledSlider Title="Max Fuel Override (% of max tank):"
                           Minimum="0" Maximum="150"
                           Value="{Binding MaxFuelPercent, Mode=TwoWay}"
                           ToolTip="Limit usable tank size for the preset (% of max tank)."/>

                    <!-- Contingency -->
                    <StackPanel Margin="0,10,0,0">
                        <StackPanel Orientation="Horizontal" Margin="0,5,0,6">
                            <TextBlock Text="Contingency Type:" VerticalAlignment="Center" Margin="0,0,10,0"
                                       ToolTip="Choose whether contingency is in laps or litres."/>
                            <RadioButton Content="Extra Laps"
                           IsChecked="{Binding ContingencyInLaps, Mode=TwoWay}"
                           GroupName="ContingencyType"
                           ToolTip="Add extra laps of fuel as a safety margin."/>
                            <RadioButton Content="Extra Litres" Margin="10,0,0,0"
                           IsChecked="{Binding ContingencyInLaps, Converter={StaticResource NotBoolConverter}, Mode=TwoWay}"
                           GroupName="ContingencyType"
                           ToolTip="Add extra litres as a safety margin."/>
                        </StackPanel>

                        <!-- Laps variant -->
                        <ui:TitledSlider Title="Contingency Laps:"
                             Minimum="0" Maximum="5"
                             Value="{Binding ContingencyValue, Mode=TwoWay}"
                             ToolTip="Number of extra laps of fuel to add.">
                            <ui:TitledSlider.Style>
                                <Style TargetType="{x:Type ui:TitledSlider}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ContingencyInLaps}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:TitledSlider.Style>
                        </ui:TitledSlider>

                        <!-- Litres variant -->
                        <ui:TitledSlider Title="Contingency Litres:"
                             Minimum="0" Maximum="20"
                             Value="{Binding ContingencyValue, Mode=TwoWay}"
                             ToolTip="Extra fuel to add as a safety margin (L).">
                            <ui:TitledSlider.Style>
                                <Style TargetType="{x:Type ui:TitledSlider}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding ContingencyInLaps}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ui:TitledSlider.Style>
                        </ui:TitledSlider>
                    </StackPanel>

                    <!-- Unified action box -->
                    <Border Height="1" Background="#444" Margin="0,12,0,12"/>
                    <Grid Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="260"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="ActionNameBox"
                     Grid.Column="0"
                     ToolTip="Enter a preset name: use for Save Current or Rename"
                     HorizontalAlignment="Stretch"/>

                        <styles:SHButtonPrimary Grid.Column="1"
                                    Content="Save Fuel Tab Data as Preset"
                                    Width="220" Height="30" Margin="8,0,0,0"
                                    Click="OnSaveCurrentAsPreset"
                                    ToolTip="Save current Fuel tab settings into a new preset name."/>

                        <styles:SHButtonSecondary Grid.Column="2"
                                      Content="Rename Selected"
                                      Width="150" Height="30" Margin="8,0,0,0"
                                      Click="OnRenamePreset"
                                      ToolTip="Rename the selected preset using the name box."/>
                    </Grid>

                </StackPanel>
            </ScrollViewer>

            <!-- Sticky footer (always bottom-right) -->
            <StackPanel Grid.Row="1"
                  Orientation="Horizontal"
                  HorizontalAlignment="Right"
                  Margin="0,10,0,0">
                <styles:SHButtonSecondary Content="Discard Changes" Width="140" Height="30" Click="OnDiscardChanges"
                                          ToolTip="Revert edits to the last saved preset values."/>
                <styles:SHButtonPrimary   Content="Save Changes"    Width="140" Height="30" Click="OnSaveEdits"
                                          ToolTip="Save edits to the selected preset."/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
