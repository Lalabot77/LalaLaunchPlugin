<UserControl x:Class="LaunchPlugin.GlobalSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:LaunchPlugin"
             xmlns:styles="clr-namespace:SimHub.Plugins.Styles;assembly=SimHub.Plugins"
             xmlns:ui="clr-namespace:SimHub.Plugins.UI;assembly=SimHub.Plugins"
             mc:Ignorable="d"
             d:DesignWidth="900" d:DesignHeight="1200"
             x:Name="GlobalSettingsPage">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </UserControl.Resources>
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="10">
            <TextBlock Text="USER VARIABLES (PER-PROFILE)" FontSize="16" FontWeight="Bold" Margin="0,5,10,0"/>
            <StackPanel Orientation="Horizontal" Margin="5,0,0,10">
                <TextBlock Text="{Binding ActiveProfile.ProfileName, StringFormat='Current Profile: {0}'}"
                           HorizontalAlignment="Left" FontSize="13" Foreground="DarkGray" VerticalAlignment="Center"/>

                <styles:SHButtonPrimary Content="Save to Profile" Margin="15,0,0,0"
                                        Command="{Binding SaveActiveProfileCommand}"
                                        ToolTip="Save the current dash user variables to this profile."
                                        Visibility="{Binding IsActiveProfileDirty, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                <styles:SHButtonPrimary Content="Return to Defaults" Margin="5,0,0,0"
                                        Command="{Binding ReturnToDefaultsCommand}"
                                        ToolTip="Resets the view to the 'Default Settings' profile."
                                        Visibility="{Binding CanReturnToDefaults, Converter={StaticResource BooleanToVisibilityConverter}}"/>
            </StackPanel>
            <Grid Margin="0,0,0,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <ui:TitledSlider Title="Rejoin Assist Linger Time (sec): " Minimum="1" Maximum="30" Value="{Binding ActiveProfile.RejoinWarningLingerTime, Mode=TwoWay}"
                                     ToolTip="How long the rejoin warning remains after you return to the track (sec)." />
                    <ui:TitledSlider Title="Rejoin Assist Clear Speed (kph): " Minimum="10" Maximum="250" Value="{Binding ActiveProfile.RejoinWarningMinSpeed, Mode=TwoWay}"
                                     ToolTip="Speed (kph) above which the rejoin warning clears automatically." />
                    <ui:TitledSlider Title="Spin Yaw Rate Threshold: " Minimum="10" Maximum="100" Value="{Binding ActiveProfile.SpinYawRateThreshold, Mode=TwoWay}"
                                     ToolTip="Yaw rate (deg/s) above which a spin is detected." />
                    <ui:TitledSlider Title="Overtake Alert activation (sec): " Minimum="1" Maximum="20" Value="{Binding ActiveProfile.TrafficApproachWarnSeconds, Mode=TwoWay}"
                                     ToolTip="Seconds to impact for an approaching car before an overtake alert triggers." />
                    <ui:TitledSlider Title="Pit Entry Decel (m/s²): " Minimum="8" Maximum="22" Value="{Binding ActiveProfile.PitEntryDecelMps2, Mode=TwoWay}"
                                     ToolTip="Target braking deceleration for pit entry assist (m/s²)." />
                    <ui:TitledSlider Title="Pit Entry Buffer (m): " Minimum="0" Maximum="40" Value="{Binding ActiveProfile.PitEntryBufferM, Mode=TwoWay}"
                                     ToolTip="Distance before pit entry to start the braking assist (m)." />
                </StackPanel>
            </Grid>

            <styles:SHSection Title="FRIENDS" ShowSeparator="True">
                <StackPanel>
                    <TextBlock Margin="0,0,0,5" Foreground="LightGray"
                               Text="Add iRacing Customer IDs to highlight friends in CarSA." />
                    <DataGrid ItemsSource="{Binding Settings.Friends}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              HeadersVisibility="Column"
                              RowEditEnding="FriendsGrid_RowEditEnding"
                              Margin="0,0,0,8">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="NAME"
                                                Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                Width="*" />
                            <DataGridTextColumn Header="UserId"
                                                Binding="{Binding UserId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                Width="120" />
                            <DataGridCheckBoxColumn Header="TEAMMATE"
                                                    Binding="{Binding IsTeammate, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                    Width="110" />
                            <DataGridTemplateColumn Header="" Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <styles:SHButtonPrimary Content="Remove"
                                                                Padding="8,2"
                                                                Margin="2"
                                                                Click="RemoveFriend_Click" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                    <styles:SHButtonPrimary Content="Add Friend"
                                            Width="120"
                                            HorizontalAlignment="Left"
                                            Click="AddFriend_Click" />
                </StackPanel>
            </styles:SHSection>

            <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="0,10,0,5" />

            <StackPanel Visibility="{Binding HardDebugEnabledForUi, Converter={StaticResource BooleanToVisibilityConverter}}">
                <TextBlock Text="DEBUG" FontSize="16" FontWeight="Bold" Margin="0,5,10,0"/>
                <styles:SHToggleCheckbox x:Name="DebugMasterToggle"
                                         Content="Enable debugging mode"
                                         Margin="0,10,0,0"
                                         IsChecked="{Binding Settings.EnableSoftDebug, Mode=TwoWay}"
                                         ToolTip="Master toggle that enables debug UI and debug processing."/>
                <Expander Header="Debug Options"
                          Margin="0,10,0,0"
                          IsExpanded="{Binding ElementName=DebugMasterToggle, Path=IsChecked}"
                          Visibility="{Binding ElementName=DebugMasterToggle, Path=IsChecked, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Margin="10,5,0,0">
                        <styles:SHToggleCheckbox Content="Enable Debug Logging" Margin="0,10,0,0"
                                                 IsChecked="{Binding Settings.EnableDebugLogging, Mode=TwoWay}"
                                                 ToolTip="Enables verbose logging for troubleshooting the plugin."/>
                        <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                            <styles:SHToggleCheckbox Content="Enable CarSA Debug Export" Margin="0,0,15,0"
                                                     IsChecked="{Binding Settings.EnableCarSADebugExport, Mode=TwoWay}"
                                                     ToolTip="Writes CarSA debug CSV logs to SimHub\Logs\LalapluginData."/>
                            <TextBlock Text="CarSA debug cadence mode" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <ComboBox Width="220" SelectedIndex="{Binding Settings.CarSADebugExportCadence, Mode=TwoWay}">
                                <ComboBoxItem Content="Tick (Hz capped)" />
                                <ComboBoxItem Content="MiniSector (default)" />
                                <ComboBoxItem Content="EventOnly" />
                            </ComboBox>
                            <TextBlock Text="Tick mode max Hz" VerticalAlignment="Center" Margin="15,0,8,0"/>
                            <TextBox Width="80" Text="{Binding Settings.CarSADebugExportTickMaxHz, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                            <styles:SHToggleCheckbox Content="EventOnly: write CarSA_Events CSV" Margin="15,0,0,0"
                                                     IsChecked="{Binding Settings.CarSADebugExportWriteEventsCsv, Mode=TwoWay}"/>
                        </StackPanel>
                        <styles:SHToggleCheckbox Content="PitExit Verbose Logging" Margin="0,10,0,0"
                                                 IsChecked="{Binding Settings.PitExitVerboseLogging, Mode=TwoWay}"
                                                 ToolTip="Adds PitExit math audit details to pit-in snapshots for troubleshooting."/>
                        <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                            <styles:SHToggleCheckbox Content="OffTrack Debug CSV" Margin="0,0,15,0"
                                                     IsChecked="{Binding Settings.EnableOffTrackDebugCsv, Mode=TwoWay}"
                                                     ToolTip="Enable per-tick OffTrack debug CSV logging for the probed car."/>
                            <TextBlock Text="Probe CarIdx" VerticalAlignment="Center" Margin="0,0,8,0"/>
                            <TextBox Width="80" Text="{Binding Settings.OffTrackDebugProbeCarIdx, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                            <TextBlock Margin="15,0,0,0" Foreground="LightGray" VerticalAlignment="Center"
                                       Text="Tip: find your PlayerCarIdx in SimHub property list"/>
                        </StackPanel>
                    </StackPanel>
                </Expander>
            </StackPanel>
        </StackPanel>
    </ScrollViewer>
</UserControl>
