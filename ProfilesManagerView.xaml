<UserControl x:Class="LaunchPlugin.ProfilesManagerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:styles="clr-namespace:SimHub.Plugins.Styles;assembly=SimHub.Plugins"
             xmlns:ui="clr-namespace:SimHub.Plugins.UI;assembly=SimHub.Plugins"
             xmlns:local="clr-namespace:LaunchPlugin"  
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">
    <UserControl.Resources>
    </UserControl.Resources>
    <Grid Margin="10">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250" MinWidth="200" />
            <ColumnDefinition Width="10" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <DockPanel Grid.Column="0">
            <TextBlock DockPanel.Dock="Top" Text="Car Profiles Library" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"
                       ToolTip="Manage car profiles stored on disk."/>
            <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                <styles:SHButtonPrimary Content="New" Width="70" Margin="2" Command="{Binding NewProfileCommand}"
                                        ToolTip="Create a new empty car profile."/>
                <styles:SHButtonPrimary Content="Copy To..." Width="80" Margin="2" Command="{Binding CopySettingsCommand}"
                                        ToolTip="Copy the selected profile into another profile."/>
                <styles:SHButtonSecondary Content="Delete" Width="70" Margin="2" Command="{Binding DeleteProfileCommand}" Background="#C82333" Foreground="White"
                                          ToolTip="Delete the selected profile from disk."/>
            </StackPanel>
            <ListBox ItemsSource="{Binding SortedCarProfiles}" SelectedItem="{Binding SelectedProfile, Mode=TwoWay}" DisplayMemberPath="ProfileName" BorderThickness="1" BorderBrush="Gray"
                     ToolTip="Select the car profile to edit."/>
        </DockPanel>

        <DockPanel Grid.Column="2" IsEnabled="{Binding IsProfileSelected}">
            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,10">
                <TextBlock Text="Editing Profile:" FontSize="16" FontWeight="Bold" VerticalAlignment="Center"
                           ToolTip="Edit settings for the selected car profile."/>
                <TextBox Text="{Binding SelectedProfile.ProfileName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                         FontSize="16" FontWeight="Normal" Margin="10,0,0,0" MinWidth="200"
                         BorderThickness="0" Background="Transparent"
                         ToolTip="Rename the selected profile."/>
            </StackPanel>
            <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                <styles:SHButtonPrimary Content="Apply to Live Session" Width="150" Margin="0,0,10,0" Command="{Binding ApplyToLiveCommand}" Height="30"
                                        ToolTip="Instantly copies these settings to the active car for this session."/>
                <styles:SHButtonPrimary Content="Save All Changes" Width="150" Command="{Binding SaveChangesCommand}" Height="30"
                                        ToolTip="Saves all profiles to the JSON file."/>
            </StackPanel>

            <TabControl>
                <styles:SHTabItem Header="DASH">
                    <StackPanel Margin="10" DataContext="{Binding SelectedProfile}">

                        <ui:TitledSlider Title="Rejoin Assist Linger Time (sec)"
                         Minimum="1" Maximum="30"
                         Value="{Binding RejoinWarningLingerTime, Mode=TwoWay}">
                            <ui:TitledSlider.ToolTip>
                                <ToolTip>
                                    <TextBlock Text="How long the rejoin warning remains visible after returning to the track (in seconds)." TextWrapping="Wrap" Width="240"/>
                                </ToolTip>
                            </ui:TitledSlider.ToolTip>
                        </ui:TitledSlider>

                        <ui:TitledSlider Title="Rejoin Assist Clear Speed (kph)"
                         Minimum="10" Maximum="250"
                         Value="{Binding RejoinWarningMinSpeed, Mode=TwoWay}">
                            <ui:TitledSlider.ToolTip>
                                <ToolTip>
                                    <TextBlock Text="The minimum speed (in km/h) above which the rejoin warning automatically clears." TextWrapping="Wrap" Width="240"/>
                                </ToolTip>
                            </ui:TitledSlider.ToolTip>
                        </ui:TitledSlider>

                        <ui:TitledSlider Title="Spin Yaw Rate Threshold"
                         Minimum="10" Maximum="100"
                         Value="{Binding SpinYawRateThreshold, Mode=TwoWay}">
                            <ui:TitledSlider.ToolTip>
                                <ToolTip>
                                    <TextBlock Text="Yaw rate (degrees per second) above which a spin event is detected and triggers rejoin assist." TextWrapping="Wrap" Width="240"/>
                                </ToolTip>
                            </ui:TitledSlider.ToolTip>
                        </ui:TitledSlider>

                        <ui:TitledSlider Title="Overtake Alert Time (sec)"
                         Minimum="1" Maximum="20"
                         Value="{Binding TrafficApproachWarnSeconds, Mode=TwoWay}">
                            <ui:TitledSlider.ToolTip>
                                <ToolTip>
                                    <TextBlock Text="How many seconds behind an approaching car must be projected to trigger the overtake alert." TextWrapping="Wrap" Width="240"/>
                                </ToolTip>
                            </ui:TitledSlider.ToolTip>
                        </ui:TitledSlider>

                        <ui:TitledSlider Title="Pit Entry Decel (m/s²)"
                         Minimum="8" Maximum="22"
                         Value="{Binding PitEntryDecelMps2, Mode=TwoWay}">
                            <ui:TitledSlider.ToolTip>
                                <ToolTip>
                                    <TextBlock Text="Target deceleration for pit entry braking assist (m/s²)." TextWrapping="Wrap" Width="240"/>
                                </ToolTip>
                            </ui:TitledSlider.ToolTip>
                        </ui:TitledSlider>

                        <ui:TitledSlider Title="Pit Entry Buffer (m)"
                         Minimum="0" Maximum="40"
                         Value="{Binding PitEntryBufferM, Mode=TwoWay}">
                            <ui:TitledSlider.ToolTip>
                                <ToolTip>
                                    <TextBlock Text="Distance before the pit entry trigger point to start the braking assist." TextWrapping="Wrap" Width="240"/>
                                </ToolTip>
                            </ui:TitledSlider.ToolTip>
                        </ui:TitledSlider>

                    </StackPanel>
                </styles:SHTabItem>


                <styles:SHTabItem Header="LAUNCH">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="10" DataContext="{Binding SelectedProfile}">

                            <ui:TitledSlider Title="Target Launch RPM"
                             Minimum="1000" Maximum="10000"
                             Value="{Binding TargetLaunchRPM, Mode=TwoWay}">
                                <ui:TitledSlider.ToolTip>
                                    <ToolTip>
                                        <TextBlock Text="The target engine RPM to hold during launch control activation." TextWrapping="Wrap" Width="240"/>
                                    </ToolTip>
                                </ui:TitledSlider.ToolTip>
                            </ui:TitledSlider>

                            <ui:TitledSlider Title="Optimal RPM Tolerance"
                             Minimum="100" Maximum="2000"
                             Value="{Binding OptimalRPMTolerance, Mode=TwoWay}">
                                <ui:TitledSlider.ToolTip>
                                    <ToolTip>
                                        <TextBlock Text="Allowed deviation (±RPM) from the target launch RPM before the system flags it as out of range." TextWrapping="Wrap" Width="240"/>
                                    </ToolTip>
                                </ui:TitledSlider.ToolTip>
                            </ui:TitledSlider>

                            <ui:TitledSlider Title="Target Launch Throttle (%)"
                             Minimum="1" Maximum="100"
                             Value="{Binding TargetLaunchThrottle, Mode=TwoWay}">
                                <ui:TitledSlider.ToolTip>
                                    <ToolTip>
                                        <TextBlock Text="Throttle percentage to apply when holding the launch RPM target." TextWrapping="Wrap" Width="240"/>
                                    </ToolTip>
                                </ui:TitledSlider.ToolTip>
                            </ui:TitledSlider>

                            <ui:TitledSlider Title="Optimal Throttle Tolerance (%)"
                             Minimum="0" Maximum="20"
                             Value="{Binding OptimalThrottleTolerance, Mode=TwoWay}">
                                <ui:TitledSlider.ToolTip>
                                    <ToolTip>
                                        <TextBlock Text="Accepted throttle percentage deviation from target before launch control gives a warning." TextWrapping="Wrap" Width="240"/>
                                    </ToolTip>
                                </ui:TitledSlider.ToolTip>
                            </ui:TitledSlider>

                            <ui:TitledSlider Title="Target Bite Point (%)"
                             Minimum="0" Maximum="100"
                             Value="{Binding TargetBitePoint, Mode=TwoWay}">
                                <ui:TitledSlider.ToolTip>
                                    <ToolTip>
                                        <TextBlock Text="Clutch engagement percentage considered the ideal bite point for launch." TextWrapping="Wrap" Width="240"/>
                                    </ToolTip>
                                </ui:TitledSlider.ToolTip>
                            </ui:TitledSlider>

                            <ui:TitledSlider Title="Bite Point Tolerance (%)"
                             Minimum="1" Maximum="10"
                             Value="{Binding BitePointTolerance, Mode=TwoWay}">
                                <ui:TitledSlider.ToolTip>
                                    <ToolTip>
                                        <TextBlock Text="Allowed deviation (±%) around the target bite point during launch setup." TextWrapping="Wrap" Width="240"/>
                                    </ToolTip>
                                </ui:TitledSlider.ToolTip>
                            </ui:TitledSlider>

                            <ui:TitledSlider Title="Bog Down Factor (%)"
                             Minimum="0" Maximum="100"
                             Value="{Binding BogDownFactorPercent, Mode=TwoWay}">
                                <ui:TitledSlider.ToolTip>
                                    <ToolTip>
                                        <TextBlock Text="Launch performance reduction factor to simulate clutch bog or wheel slip." TextWrapping="Wrap" Width="240"/>
                                    </ToolTip>
                                </ui:TitledSlider.ToolTip>
                            </ui:TitledSlider>

                            <ui:TitledSlider Title="Anti-Stall Alert Threshold (%)"
                             Minimum="0" Maximum="100"
                             Value="{Binding AntiStallThreshold, Mode=TwoWay}">
                                <ui:TitledSlider.ToolTip>
                                    <ToolTip>
                                        <TextBlock Text="Throttle or clutch percentage threshold below which an anti-stall warning is triggered." TextWrapping="Wrap" Width="240"/>
                                    </ToolTip>
                                </ui:TitledSlider.ToolTip>
                            </ui:TitledSlider>

                        </StackPanel>
                    </ScrollViewer>
                </styles:SHTabItem>


                <styles:SHTabItem Header="SHIFT">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="10" MaxWidth="860" HorizontalAlignment="Left">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="24"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <styles:SHToggleCheckbox Grid.Column="0" Content="Enable Shift Assist" IsChecked="{Binding ShiftAssistEnabled, Mode=TwoWay}" VerticalAlignment="Center"/>
                                <styles:SHToggleCheckbox Grid.Column="2" Content="Learning mode" IsChecked="{Binding ShiftAssistLearningModeEnabled, Mode=TwoWay}" VerticalAlignment="Center"
                                                         ToolTip="Enables data mining for shift-point learning and allows the dash learning overlay to be shown." />
                            </Grid>

                            <Grid Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="120" />
                                    <ColumnDefinition Width="24" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="120" />
                                    <ColumnDefinition Width="24" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="120" />
                                </Grid.ColumnDefinitions>
                                <styles:SHToggleCheckbox Grid.Column="0" Content="Shift Light" IsChecked="{Binding ShiftAssistLightEnabled, Mode=TwoWay}" VerticalAlignment="Center"
                                                         ToolTip="Controls whether the ShiftAssist.Beep light/export should be considered enabled for dash visibility."/>
                                <Grid Grid.Column="3" Grid.ColumnSpan="2">
                                    <Grid.Style>
                                        <Style TargetType="Grid">
                                            <Setter Property="Visibility" Value="Visible"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding ShiftAssistLightEnabled}" Value="False">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Grid.Style>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="120"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Shift Light Duration (ms)" VerticalAlignment="Center" Margin="0,0,8,0"
                                               ToolTip="Controls how long the ShiftAssist.Beep export remains active. Does not affect WAV playback length."/>
                                    <TextBox Grid.Column="1" Text="{Binding ShiftAssistBeepDurationMs, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" />
                                </Grid>
                                <TextBlock Grid.Column="6" Text="Lead time (ms)" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                <TextBox Grid.Column="7" Text="{Binding ShiftAssistLeadTimeMs, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" />
                            </Grid>

                            <Grid Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="16"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <styles:SHToggleCheckbox Grid.Column="0" Content="Shift Sound" IsChecked="{Binding ShiftAssistBeepSoundEnabled, Mode=TwoWay}" VerticalAlignment="Center"/>
                                <Grid Grid.Column="1" Grid.ColumnSpan="3">
                                    <Grid.Style>
                                        <Style TargetType="Grid">
                                            <Setter Property="Visibility" Value="Visible"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding ShiftAssistBeepSoundEnabled}" Value="False">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Grid.Style>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="16" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="220" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <styles:SHButtonPrimary Grid.Column="0" Content="Test Sound" Command="{Binding ShiftTestBeepCommand}" MinWidth="90"/>
                                    <TextBlock Grid.Column="2" Text="Beep volume" VerticalAlignment="Center" Margin="0,0,8,0"
                                        ToolTip="Not implemented yet. Uses SimHub master volume."/>
                                    <Slider Grid.Column="3"
                                        VerticalAlignment="Center"
                                        Minimum="0"
                                        Maximum="100"
                                        TickFrequency="1"
                                        IsSnapToTickEnabled="True"
                                        Value="{Binding ShiftAssistBeepVolumePct, Mode=TwoWay}"
                                        IsEnabled="False"
                                        Opacity="0.6"
                                        ToolTip="Not implemented yet. Uses SimHub master volume."/>
                                    <TextBlock Grid.Column="4"
                                       Text="{Binding ShiftAssistBeepVolumePct, StringFormat={}{0}%}"
                                       VerticalAlignment="Center"
                                       Margin="10,0,0,0"
                                       MinWidth="48"
                                       Opacity="0.6"/>
                                </Grid>
                            </Grid>

                            <TextBlock Text="Gear stack selection" FontWeight="SemiBold" Margin="0,10,0,4"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="200" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                </Grid.ColumnDefinitions>
                                <ComboBox Grid.Column="0" ItemsSource="{Binding ShiftStackIds}" SelectedItem="{Binding SelectedShiftStackId, Mode=TwoWay}" Margin="0,0,8,0" MinWidth="130"/>
                                <styles:SHButtonPrimary Grid.Column="1" Content="Add current" Command="{Binding ShiftAddCurrentStackCommand}" Margin="0,0,8,0" ToolTip="Add/select the currently active stack name."/>
                                <styles:SHButtonPrimary Grid.Column="2" Content="Save As..." Command="{Binding ShiftSaveStackAsCommand}" Margin="0,0,8,0" ToolTip="Duplicate selected stack into a new named stack."/>
                                <styles:SHButtonSecondary Grid.Column="3" Content="Delete" Command="{Binding ShiftDeleteStackCommand}" Margin="0,0,8,0" Background="#C82333" Foreground="White" ToolTip="Delete selected stack (Default cannot be deleted)."/>
                            </Grid>

                            <DockPanel Margin="0,12,0,6">
                                <TextBlock DockPanel.Dock="Left" Text="Shift targets (RPM)" FontWeight="SemiBold" VerticalAlignment="Center"/>
                                <Border DockPanel.Dock="Right" BorderThickness="1" BorderBrush="#505050" CornerRadius="4" Padding="8,6" Background="#22000000" Margin="12,0,0,0" MaxWidth="730">
                                    <WrapPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,10,0">
                                            <TextBlock Text="State:" FontWeight="SemiBold" Margin="0,0,4,0"/>
                                            <TextBlock Text="{Binding ShiftAssistLearningState}"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,10,0">
                                            <TextBlock Text="Active gear:" FontWeight="SemiBold" Margin="0,0,4,0"/>
                                            <TextBlock Text="{Binding ShiftAssistLearningActiveGearText}"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,10,0">
                                            <TextBlock Text="Peak:" FontWeight="SemiBold" Margin="0,0,4,0"/>
                                            <TextBlock Text="{Binding ShiftAssistLearningPeakAccelText}"/>
                                            <TextBlock Text=" m/s² @ " />
                                            <TextBlock Text="{Binding ShiftAssistLearningPeakRpmText}"/>
                                            <TextBlock Text=" rpm" />
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Delay:" FontWeight="SemiBold" Margin="0,0,4,0"/>
                                            <TextBlock Text="{Binding ShiftAssistDelayPendingSummary}"/>
                                        </StackPanel>
                                    </WrapPanel>
                                </Border>
                            </DockPanel>
                            <TextBlock Text="{Binding ShiftAssistCurrentGearRedlineHint}" Margin="0,0,0,6" Opacity="0.85"/>
                            <Grid Grid.IsSharedSizeScope="True">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <TextBlock Grid.Row="0" Text="{Binding ActiveShiftStackLabel}" FontSize="13" FontWeight="SemiBold" Margin="0,0,0,6"/>
                                <Grid Grid.Row="1" Margin="0,0,0,6">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="122" SharedSizeGroup="GearCol"/>
                                        <ColumnDefinition Width="160" SharedSizeGroup="TargetCol"/>
                                        <ColumnDefinition Width="58" SharedSizeGroup="LockCol"/>
                                        <ColumnDefinition Width="220" SharedSizeGroup="LearnedCol"/>
                                        <ColumnDefinition Width="55" SharedSizeGroup="SamplesCol"/>
                                        <ColumnDefinition Width="160" SharedSizeGroup="DelayCol"/>
                                        <ColumnDefinition Width="55" SharedSizeGroup="DelaySamplesCol"/>
                                    </Grid.ColumnDefinitions>
                                    <styles:SHButtonSecondary Grid.Column="1" Content="Reset Targets" MinWidth="96" Command="{Binding ShiftResetTargetsCommand}" Margin="0,0,6,0" HorizontalAlignment="Left" Background="#FD7E14" Foreground="White"/>
                                    <StackPanel Grid.Column="3" Orientation="Horizontal" HorizontalAlignment="Left">
                                        <styles:SHButtonSecondary Content="Reset Learning" MinWidth="102" Command="{Binding ShiftResetLearningCommand}" Margin="0,0,6,0" HorizontalAlignment="Left" Background="#FD7E14" Foreground="White"/>
                                        <styles:SHButtonPrimary Content="Apply Learned (Override Locks)" MinWidth="190" Command="{Binding ShiftApplyLearnedOverrideCommand}" HorizontalAlignment="Left"
                                                           ToolTip="Testing utility: overwrite active stack targets with learned RPM values. Ignores locks and does not change lock states."/>
                                    </StackPanel>
                                    <styles:SHButtonSecondary Grid.Column="5" Content="Reset Delays" MinWidth="92" Command="{Binding ShiftResetDelaysCommand}" Margin="0,0,6,0" HorizontalAlignment="Left" Background="#FD7E14" Foreground="White"/>
                                </Grid>
                                <Grid Grid.Row="2" Margin="0,0,0,3">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="122" SharedSizeGroup="GearCol"/>
                                        <ColumnDefinition Width="86" SharedSizeGroup="TargetCol"/>
                                        <ColumnDefinition Width="58" SharedSizeGroup="LockCol"/>
                                        <ColumnDefinition Width="82" SharedSizeGroup="LearnedCol"/>
                                        <ColumnDefinition Width="55" SharedSizeGroup="SamplesCol"/>
                                        <ColumnDefinition Width="76" SharedSizeGroup="DelayCol"/>
                                        <ColumnDefinition Width="55" SharedSizeGroup="DelaySamplesCol"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Gear" FontWeight="SemiBold" Opacity="0.8"/>
                                    <TextBlock Grid.Column="1" Text="Target" FontWeight="SemiBold" Opacity="0.8"/>
                                    <TextBlock Grid.Column="2" Text="Lock" FontWeight="SemiBold" Opacity="0.8"/>
                                    <TextBlock Grid.Column="3" Text="Learned" FontWeight="SemiBold" Opacity="0.8" TextAlignment="Right"/>
                                    <TextBlock Grid.Column="4" Text="N" FontWeight="SemiBold" Opacity="0.8" TextAlignment="Right"/>
                                    <TextBlock Grid.Column="5" Text="Delay" FontWeight="SemiBold" Opacity="0.8" TextAlignment="Right"/>
                                    <TextBlock Grid.Column="6" Text="N" FontWeight="SemiBold" Opacity="0.8" TextAlignment="Right"/>
                                    <Border Grid.Column="0" Grid.ColumnSpan="7" Height="1" Background="#444" VerticalAlignment="Bottom" Margin="0,0,0,-2"/>
                                </Grid>

                                <ItemsControl Grid.Row="3" ItemsSource="{Binding ShiftGearRows}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="0,1,0,1" MinHeight="24">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="122" SharedSizeGroup="GearCol"/>
                                                    <ColumnDefinition Width="86" SharedSizeGroup="TargetCol"/>
                                                    <ColumnDefinition Width="58" SharedSizeGroup="LockCol"/>
                                                    <ColumnDefinition Width="82" SharedSizeGroup="LearnedCol"/>
                                                    <ColumnDefinition Width="55" SharedSizeGroup="SamplesCol"/>
                                                    <ColumnDefinition Width="76" SharedSizeGroup="DelayCol"/>
                                                    <ColumnDefinition Width="55" SharedSizeGroup="DelaySamplesCol"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="{Binding GearLabel}" VerticalAlignment="Center" />
                                                <TextBox Grid.Column="1" Text="{Binding RpmText, Mode=OneWay}" LostFocus="ShiftRpmTextBox_LostFocus" Height="22"/>
                                                <CheckBox Grid.Column="2"
                                                      Content="Lock"
                                                      IsChecked="{Binding IsLocked, Mode=OneWay}"
                                                      VerticalAlignment="Center"
                                                      Margin="6,0,0,0"
                                                      Checked="ShiftLockCheckBox_Checked"
                                                      Unchecked="ShiftLockCheckBox_Unchecked" />
                                                <TextBlock Grid.Column="3" Text="{Binding LearnedRpmText}" VerticalAlignment="Center" TextAlignment="Right"/>
                                                <TextBlock Grid.Column="4" Text="{Binding SampleCountText}" VerticalAlignment="Center" TextAlignment="Right"/>
                                                <TextBlock Grid.Column="5" Text="{Binding DelayAvgMsText}" VerticalAlignment="Center" TextAlignment="Right"/>
                                                <TextBlock Grid.Column="6" Text="{Binding DelayCountText}" VerticalAlignment="Center" TextAlignment="Right"/>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>

                            <TextBlock Text="Sound" FontWeight="SemiBold" Margin="0,14,0,6"/>
                            <styles:SHToggleCheckbox Content="Use custom sound" IsChecked="{Binding ShiftAssistUseCustomWav, Mode=TwoWay}" />
                            <Grid Margin="0,6,0,0">
                                <Grid.Style>
                                    <Style TargetType="Grid">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ShiftAssistUseCustomWav}" Value="False">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Grid.Style>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Text="{Binding ShiftAssistCustomWavPath, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" VerticalAlignment="Center" />
                                <styles:SHButtonPrimary Grid.Column="1" Content="Browse" Command="{Binding ShiftBrowseCustomWavCommand}" Margin="8,0,0,0" />
                            </Grid>
                        </StackPanel>
                    </ScrollViewer>
                </styles:SHTabItem>


                <styles:SHTabItem Header="FUEL">
                    <StackPanel Margin="10" DataContext="{Binding SelectedProfile}">
                        <ui:TitledSlider Title="Contingency Laps/Litres" Minimum="0" Maximum="10" Value="{Binding FuelContingencyValue, Mode=TwoWay}"
                                         ToolTip="Default contingency amount added to fuel plans." />
                        <styles:SHToggleCheckbox Content="Contingency is in Laps (otherwise Litres)" IsChecked="{Binding IsContingencyInLaps, Mode=TwoWay}" Margin="5,10,0,0"
                                                 ToolTip="Toggle whether the contingency value represents laps or litres."/>
                        <ui:TitledSlider Title="Wet Fuel Multiplier (%)" Minimum="70" Maximum="130" Value="{Binding WetFuelMultiplier, Mode=TwoWay}" Margin="0,15,0,0"
                                         ToolTip="Fuel burn multiplier for wet conditions (%)."/>

                        <Grid Margin="0,15,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="Race Pace Delta (seconds):" ToolTip="How many seconds slower your average race pace is compared to your personal best lap (e.g., 1.2)."/>
                            <Grid Grid.Row="1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Slider Grid.Column="0" VerticalAlignment="Center" Value="{Binding RacePaceDeltaSeconds, Mode=TwoWay}" Minimum="0" Maximum="5" SmallChange="0.1" TickFrequency="0.1" IsSnapToTickEnabled="True"
                                        ToolTip="Adjust the race pace delta used for planning (sec)."/>
                                <TextBlock Grid.Column="1" Text="{Binding RacePaceDeltaSeconds, StringFormat=N1}" VerticalAlignment="Center" Margin="10,0,0,0" MinWidth="35" TextAlignment="Right"/>
                            </Grid>
                        </Grid>

                        <Grid Margin="0,15,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="20" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Refuel Rate (L/s):" ToolTip="Average refuel rate (L/s). Updates after a live refuel event if available."/>
                                <Grid Margin="0,4,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Slider Grid.Column="0" VerticalAlignment="Center" Value="{Binding RefuelRate, Mode=TwoWay}" Minimum="1" Maximum="10" SmallChange="0.05" TickFrequency="0.05" IsSnapToTickEnabled="True"
                                            ToolTip="Set the refuel rate (L/s). Live refuel events can update this value."/>
                                    <TextBlock Grid.Column="1" Text="{Binding RefuelRate, StringFormat=N2}" VerticalAlignment="Center" Margin="10,0,0,0" MinWidth="35" TextAlignment="Right"/>
                                </Grid>
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Base Tank (L):" ToolTip="Base tank capacity for this car. Use Learn from Live to pull from live max fuel."/>
                                <Grid Margin="0,4,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <TextBox Grid.Column="0"
                                             Margin="0,0,0,0"
                                             TextAlignment="Right"
                                             Text="{Binding BaseTankLitres, Mode=TwoWay, UpdateSourceTrigger=LostFocus, TargetNullValue=''}"
                                             ToolTip="Base tank size (L). Leave blank to use the default."/>
                                    <styles:SHButtonSecondary Grid.Column="1"
                                                              Content="Learn from Live"
                                                              Margin="8,0,0,0"
                                                              Command="{Binding DataContext.LearnBaseTankCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                              ToolTip="Capture the current live max fuel as the base tank size."/>
                                </Grid>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </styles:SHTabItem>

                <styles:SHTabItem Header="TRACKS">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="200" MinWidth="180" />
                            <ColumnDefinition Width="10" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <DockPanel Grid.Column="0">
                            <TextBlock DockPanel.Dock="Top" Text="Recorded Tracks" FontWeight="Bold" Margin="0,0,0,10"
                                       ToolTip="Tracks with saved data for this profile."/>
                            <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,10,0,0">
                                <styles:SHButtonSecondary Content="Delete" Width="80" Command="{Binding DeleteTrackCommand}" Background="#C82333" Foreground="White"
                                                          ToolTip="Delete the selected track data from this profile."/>
                            </StackPanel>
                            <ListBox ItemsSource="{Binding TracksForSelectedProfile}" SelectedItem="{Binding SelectedTrack, Mode=TwoWay}" DisplayMemberPath="DisplayName" BorderThickness="1" BorderBrush="Gray"
                                     ToolTip="Select a track to edit its saved data."/>
                        </DockPanel>

                        <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                            <StackPanel DataContext="{Binding SelectedTrack}" Grid.IsSharedSizeScope="True" IsEnabled="{Binding DataContext.IsTrackSelected, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                <TextBlock FontWeight="Bold"
                                           ToolTip="Edit saved data for the selected track.">
                                    <Run Text="Editing Data for: "/>
                                    <Run Text="{Binding DisplayName}"/>
                                </TextBlock>
                                <Border Height="1" Background="#444" Margin="0,5,0,10"/>

                                <!-- PIT DATA (Pit Loss + Track Markers) -->
                                <GroupBox Header="Pit Data" Margin="0,0,0,10"
                                          ToolTip="Pit lane loss and pit entry/exit markers for this track.">
                                    <Grid Margin="8,6,8,8" Grid.IsSharedSizeScope="True">
                                        <Grid.RowDefinitions>
                                            <!-- Pit loss line -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Pit loss info lines -->
                                            <RowDefinition Height="Auto"/>

                                            <!-- Divider -->
                                            <RowDefinition Height="Auto"/>

                                            <!-- Markers: Entry -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Markers: Exit -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Markers: Updated -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Markers: lock + reload -->
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" SharedSizeGroup="LabelColumn" MinWidth="170"/>
                                            <ColumnDefinition Width="60" SharedSizeGroup="ValueColumn"/>
                                            <ColumnDefinition Width="*" SharedSizeGroup="InfoColumn" MinWidth="220"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- ========================= -->
                                        <!-- Pit loss (SelectedTrack)  -->
                                        <!-- ========================= -->

                                        <TextBlock Grid.Row="0" Grid.Column="0"
                   Text="Pit Lane Loss (s):"
                   Margin="0,6,10,0"
                   VerticalAlignment="Center"
                   ToolTip="Estimated pit lane loss per stop (sec). Updates from live pits when unlocked."/>

                                        <TextBox Grid.Row="0" Grid.Column="1"
                 Margin="0,6,0,0"
                 TextAlignment="Right"
                 Text="{Binding PitLaneLossSecondsText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                 ToolTip="Manual override for pit lane loss (sec)."/>

                                        <CheckBox Grid.Row="0" Grid.Column="2"
                  Margin="12,6,0,0"
                  VerticalAlignment="Center"
                  Content="Locked"
                  IsChecked="{Binding PitLaneLossLocked, Mode=TwoWay}"
                  ToolTip="Lock to prevent live pit samples from overwriting this value."/>

                                        <!-- Pit loss info lines -->
                                        <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,6,0,0">
                                            <TextBlock FontStyle="Italic" Foreground="#FF9AA0A6">
                <Run Text="{Binding PitLaneLossSource, TargetNullValue=Manual}"/>
                <Run Text=": "/>
                <Run Text="{Binding PitLaneLossUpdatedUtc, StringFormat={}{0:yyyy-MM-dd HH:mm}}"/>
                                            </TextBlock>

                                            <TextBlock FontStyle="Italic" Foreground="#FF9AA0A6">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding PitLaneLossBlockedCandidateDisplay, Mode=OneWay}" Value="">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                <Run Text="{Binding PitLaneLossBlockedCandidateDisplay, Mode=OneWay}"/>
                                            </TextBlock>
                                        </StackPanel>

                                        <!-- Divider -->
                                        <Border Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3"
                Height="1"
                Background="#444"
                Margin="0,12,0,12"/>

                                        <!-- ================================== -->
                                        <!-- Pit track markers (Parent VM DC)    -->
                                        <!-- ================================== -->

                                        <Grid Grid.Row="3" Grid.RowSpan="4" Grid.Column="0" Grid.ColumnSpan="3"
                                            DataContext="{Binding DataContext, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" SharedSizeGroup="LabelColumn" MinWidth="170"/>
                                                <ColumnDefinition Width="60" SharedSizeGroup="ValueColumn"/>
                                                <ColumnDefinition Width="*" SharedSizeGroup="InfoColumn" MinWidth="220"/>
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Grid.Row="0" Grid.Column="0"
                                               Text="Stored Pit Entry %:"
                                               VerticalAlignment="Center"
                                               ToolTip="Saved pit entry marker as % of lap distance."/>
                                            <TextBlock Grid.Row="0" Grid.Column="1"
                                               Text="{Binding StoredPitEntryPctText}"
                                               TextAlignment="Right"
                                               VerticalAlignment="Center"/>
                                            <CheckBox Grid.Row="0" Grid.Column="2"
                                              Margin="12,0,0,0"
                                              VerticalAlignment="Center"
                                              Content="Locked"
                                              IsChecked="{Binding TrackMarkersLocked, Mode=TwoWay}"
                                              ToolTip="Lock to prevent live marker updates from overwriting pit entry/exit values."/>

                                            <TextBlock Grid.Row="1" Grid.Column="0"
                                               Margin="0,6,0,0"
                                               Text="Stored Pit Exit %:"
                                               VerticalAlignment="Center"
                                               ToolTip="Saved pit exit marker as % of lap distance."/>
                                            <TextBlock Grid.Row="1" Grid.Column="1"
                                               Margin="0,6,0,0"
                                               Text="{Binding StoredPitExitPctText}"
                                               TextAlignment="Right"
                                               VerticalAlignment="Center"/>

                                            <TextBlock Grid.Row="2" Grid.Column="0"
                                               Margin="0,6,0,0" FontStyle="Italic" Foreground="#FF9AA0A6"
                                               Text="Last Updated (UTC):"
                                               VerticalAlignment="Center"
                                               ToolTip="Last time these pit markers were updated."/>
                                            <TextBlock Grid.Row="2" Grid.Column="1"
                                               Margin="0,6,0,0" FontStyle="Italic" Foreground="#FF9AA0A6"
                                               Text="{Binding TrackMarkersLastUpdatedText}"
                                               VerticalAlignment="Center"/>

                                            <StackPanel
                                                Grid.Row="3"
                                                Grid.Column="0"
                                                Grid.ColumnSpan="3"
                                                Orientation="Horizontal"
                                                Margin="0,10,0,0"
                                                HorizontalAlignment="Left">
                                                <styles:SHButtonPrimary
                                                    Content="Refresh markers from file"
                                                    Command="{Binding ReloadTrackMarkersCommand}"
                                                    Margin="4,4,4,4"
                                                    ToolTip="Reload LalaLaunch.TrackMarkers.json from disk (for manual edits)."/>
                                                <styles:SHButtonPrimary
                                                    Content="Zero and Relearn"
                                                    Command="{Binding RelearnPitDataCommand}" Click="SHButtonPrimary_Click"
                                                    ToolTip="Clear pit markers and relearn them from the next live pit cycle."/>
                                            </StackPanel>


                                        </Grid>

                                    </Grid>
                                </GroupBox>

                                <!-- DRY CONDITIONS -->
                                <GroupBox Header="Dry Conditions Data" Margin="0,0,0,10"
                                          ToolTip="Dry-condition pace and fuel data for this track.">
                                    <Grid Margin="8,6,8,8" Grid.IsSharedSizeScope="True">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <!-- Avg lap -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Fuel ECO -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Fuel AVG -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Fuel MAX -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Info + lock -->
                                        </Grid.RowDefinitions>

                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" SharedSizeGroup="LabelColumn" MinWidth="170"/>
                                            <ColumnDefinition Width="60" SharedSizeGroup="ValueColumn"/>
                                            <ColumnDefinition Width="*" SharedSizeGroup="InfoColumn" MinWidth="220"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Best lap time -->
                                        <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Best Lap Time (m:ss.fff):"
                                           Margin="0,0,10,0"
                                           VerticalAlignment="Center"
                                           ToolTip="Best dry lap time stored for this track."/>
                                        <TextBox Grid.Row="0" Grid.Column="1"
                                             TextAlignment="Right"
                                             Text="{Binding BestLapTimeDryText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for best dry lap time (m:ss.fff)."/>
                                        <TextBlock Grid.Row="0" Grid.Column="2"
                                               Margin="12,0,0,0"
                                               VerticalAlignment="Center"
                                               Text="{Binding DryBestLapLastUpdatedText, Mode=OneWay}"
                                               FontStyle="Italic"
                                               Foreground="#FF9AA0A6"
                                               TextWrapping="Wrap"/>

                                        <!-- Avg lap time -->
                                        <TextBlock Grid.Row="1" Grid.Column="0"
                                           Text="Avg Lap Time (m:ss.fff):"
                                           Margin="0,6,10,0"
                                           VerticalAlignment="Center"
                                           ToolTip="Average dry lap time used for planning (m:ss.fff)."/>
                                        <TextBox Grid.Row="1" Grid.Column="1"
                                             Margin="0,6,0,0"
                                             TextAlignment="Right"
                                             Text="{Binding AvgLapTimeDryText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for average dry lap time (m:ss.fff)."/>
                                        <StackPanel
                                            Grid.Row="1"
                                            Grid.Column="2"
                                            Orientation="Horizontal"
                                            Margin="12,6,0,0"
                                            VerticalAlignment="Center">

                                            <TextBlock
                                                Text="{Binding DryLapTimeSampleCount, StringFormat=Sample: {0}}"
                                                Margin="0,0,10,0"/>

                                            <TextBlock
                                                Text="{Binding DryAvgLapLastUpdatedText, Mode=OneWay}"
                                                FontStyle="Italic"
                                                Foreground="#FF9AA0A6"
                                                TextWrapping="Wrap"/>
                                        </StackPanel>

                                        <!-- Fuel burn label (only once) -->
                                        <TextBlock Grid.Row="2" Grid.Column="0"
                                           Text="Fuel Burn (L/lap):"
                                           Margin="0,6,10,0"
                                           VerticalAlignment="Center"
                                           ToolTip="Dry fuel burn values used for planning (L/lap)."/>

                                        <!-- ECO -->
                                        <TextBlock Grid.Row="2" Grid.Column="0"
                                           Margin="120,6,10,0"
                                           Text="ECO"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"
                                           ToolTip="Lowest observed dry fuel burn (L/lap)."/>
                                        <TextBox Grid.Row="2" Grid.Column="1"
                                             Margin="0,6,0,0"
                                             TextAlignment="Right"
                                             Text="{Binding MinFuelPerLapDryText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for dry ECO fuel burn (L/lap)."/>

                                        <!-- AVG -->
                                        <TextBlock Grid.Row="3" Grid.Column="0"
                                           Margin="120,0,10,0"
                                           Text="AVG"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"
                                           ToolTip="Average observed dry fuel burn (L/lap)."/>
                                        <TextBox Grid.Row="3" Grid.Column="1"
                                             TextAlignment="Right"
                                             Text="{Binding AvgFuelPerLapDryText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for dry AVG fuel burn (L/lap)."/>

                                        <!-- MAX -->
                                        <TextBlock Grid.Row="4" Grid.Column="0"
                                           Margin="120,0,10,0"
                                           Text="MAX"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"
                                           ToolTip="Highest observed dry fuel burn (L/lap)."/>
                                        <TextBox Grid.Row="4" Grid.Column="1"
                                             TextAlignment="Right"
                                             Text="{Binding MaxFuelPerLapDryText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for dry MAX fuel burn (L/lap)."/>

                                        <!-- Fuel sample / updated -->
                                        <StackPanel
                                            Grid.Row="3"
                                            Grid.Column="2"
                                            Orientation="Horizontal"
                                            Margin="12,0,0,0"
                                            VerticalAlignment="Center">

                                            <TextBlock
                                                Text="{Binding DryFuelSampleCount, StringFormat=Sample: {0}}"
                                                Margin="0,0,10,0"
                                                ToolTip="Number of dry fuel samples collected for this track."/>

                                            <TextBlock
                                                Text="{Binding DryFuelLastUpdatedText, Mode=OneWay}"
                                                FontStyle="Italic"
                                                Foreground="#FF9AA0A6"
                                                TextWrapping="Wrap"
                                                ToolTip="Last time dry fuel data was updated."/>
                                        </StackPanel>

                                        <!-- Placeholder lock -->
                                        <StackPanel Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="3"
                                            Orientation="Horizontal"
                                            Margin="0,8,0,0"
                                            HorizontalAlignment="Left">
                                            <CheckBox
                                                Content="Locked"
                                                IsChecked="{Binding DryConditionsLocked, Mode=TwoWay}"
                                                ToolTip="Lock to prevent live dry data from overwriting these values."/>
                                            <styles:SHButtonPrimary
                                                Content="Zero and Relearn"
                                                Command="{Binding DataContext.RelearnDryCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                Margin="10,0,0,0"
                                                ToolTip="Clear dry data and relearn from new live laps (while unlocked)."/>
                                        </StackPanel>
                                    </Grid>
                                </GroupBox>


                                <!-- WET CONDITIONS -->
                                <GroupBox Header="Wet Conditions Data" Margin="0,0,0,10"
                                          ToolTip="Wet-condition pace and fuel data for this track.">
                                    <Grid Margin="8,6,8,8" Grid.IsSharedSizeScope="True">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <!-- Avg lap -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Fuel ECO -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Fuel AVG -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Fuel MAX -->
                                            <RowDefinition Height="Auto"/>
                                            <!-- Info + lock -->
                                        </Grid.RowDefinitions>

                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" SharedSizeGroup="LabelColumn" MinWidth="170"/>
                                            <ColumnDefinition Width="60" SharedSizeGroup="ValueColumn"/>
                                            <ColumnDefinition Width="*" SharedSizeGroup="InfoColumn" MinWidth="220"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Best lap time -->
                                        <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Best Lap Time (m:ss.fff):"
                                           Margin="0,0,10,0"
                                           VerticalAlignment="Center"
                                           ToolTip="Best wet lap time stored for this track."/>
                                        <TextBox Grid.Row="0" Grid.Column="1"
                                             TextAlignment="Right"
                                             Text="{Binding BestLapTimeWetText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for best wet lap time (m:ss.fff)."/>
                                        <TextBlock Grid.Row="0" Grid.Column="2"
                                           Margin="12,0,0,0"
                                           VerticalAlignment="Center"
                                           Text="{Binding WetBestLapLastUpdatedText, Mode=OneWay}"
                                           FontStyle="Italic"
                                           Foreground="#FF9AA0A6"
                                           TextWrapping="Wrap"/>

                                        <!-- Avg lap time -->
                                        <TextBlock Grid.Row="1" Grid.Column="0"
                                           Text="Avg Lap Time (m:ss.fff):"
                                           Margin="0,6,10,0"
                                           VerticalAlignment="Center"
                                           ToolTip="Average wet lap time used for planning (m:ss.fff)."/>
                                        <TextBox Grid.Row="1" Grid.Column="1"
                                             Margin="0,6,0,0"
                                             TextAlignment="Right"
                                             Text="{Binding AvgLapTimeWetText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for average wet lap time (m:ss.fff)."/>
                                        <StackPanel
                                            Grid.Row="1"
                                            Grid.Column="2"
                                            Orientation="Horizontal"
                                            Margin="12,6,0,0"
                                            VerticalAlignment="Center">

                                            <TextBlock
                                                Text="{Binding WetLapTimeSampleCount, StringFormat=Sample: {0}}"
                                                Margin="0,0,10,0"/>

                                            <TextBlock
                                                Text="{Binding WetAvgLapLastUpdatedText, Mode=OneWay}"
                                                FontStyle="Italic"
                                                Foreground="#FF9AA0A6"
                                                TextWrapping="Wrap"/>
                                        </StackPanel>

                                        <!-- Fuel burn label (only once) -->
                                        <TextBlock Grid.Row="2" Grid.Column="0"
                                           Text="Fuel Burn (L/lap):"
                                           Margin="0,6,10,0"
                                           VerticalAlignment="Center"
                                           ToolTip="Wet fuel burn values used for planning (L/lap)."/>

                                        <!-- ECO -->
                                        <TextBlock Grid.Row="2" Grid.Column="0"
                                           Margin="120,6,10,0"
                                           Text="ECO"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"
                                           ToolTip="Lowest observed wet fuel burn (L/lap)."/>
                                        <TextBox Grid.Row="2" Grid.Column="1"
                                             Margin="0,6,0,0"
                                             TextAlignment="Right"
                                             Text="{Binding MinFuelPerLapWetText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for wet ECO fuel burn (L/lap)."/>

                                        <!-- AVG -->
                                        <TextBlock Grid.Row="3" Grid.Column="0"
                                           Margin="120,0,10,0"
                                           Text="AVG"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"
                                           ToolTip="Average observed wet fuel burn (L/lap)."/>
                                        <TextBox Grid.Row="3" Grid.Column="1"
                                             TextAlignment="Right"
                                             Text="{Binding AvgFuelPerLapWetText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for wet AVG fuel burn (L/lap)."/>

                                        <!-- MAX -->
                                        <TextBlock Grid.Row="4" Grid.Column="0"
                                           Margin="120,0,10,0"
                                           Text="MAX"
                                           FontWeight="SemiBold"
                                           VerticalAlignment="Center"
                                           ToolTip="Highest observed wet fuel burn (L/lap)."/>
                                        <TextBox Grid.Row="4" Grid.Column="1"
                                             TextAlignment="Right"
                                             Text="{Binding MaxFuelPerLapWetText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                             ToolTip="Manual override for wet MAX fuel burn (L/lap)."/>

                                        <!-- Fuel sample / updated -->
                                        <StackPanel
                                            Grid.Row="3"
                                            Grid.Column="2"
                                            Orientation="Horizontal"
                                            Margin="12,0,0,0"
                                            VerticalAlignment="Center">

                                            <TextBlock
                                                Text="{Binding WetFuelSampleCount, StringFormat=Sample: {0}}"
                                                Margin="0,0,10,0"
                                                ToolTip="Number of wet fuel samples collected for this track."/>

                                            <TextBlock
                                                Text="{Binding WetFuelLastUpdatedText, Mode=OneWay}"
                                                FontStyle="Italic"
                                                Foreground="#FF9AA0A6"
                                                TextWrapping="Wrap"
                                                ToolTip="Last time wet fuel data was updated."/>
                                        </StackPanel>

                                        <!-- Placeholder lock -->
                                        <StackPanel Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="3"
                                            Orientation="Horizontal"
                                            Margin="0,8,0,0"
                                            HorizontalAlignment="Left">
                                            <CheckBox
                                                Content="Locked"
                                                IsChecked="{Binding WetConditionsLocked, Mode=TwoWay}"
                                                ToolTip="Lock to prevent live wet data from overwriting these values."/>
                                            <styles:SHButtonPrimary
                                                Content="Zero and Relearn"
                                                Command="{Binding DataContext.RelearnWetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                Margin="10,0,0,0"
                                                ToolTip="Clear wet data and relearn from new live laps (while unlocked)."/>
                                        </StackPanel>
                                    </Grid>
                                </GroupBox>

                                <!-- WET VS DRY AVG DELTAS -->
                                <GroupBox Header="Wet vs Dry Avg Deltas" Margin="0,0,0,10"
                                          ToolTip="Computed deltas between wet and dry averages for this track.">
                                    <Grid Margin="8,6,8,8">
                                        <TextBlock TextWrapping="Wrap">
                                            <Run Text="{Binding WetVsDryAvgLapDeltaText, Mode=OneWay}" />
                                            <Run Text="  |  " />
                                            <Run Text="{Binding WetVsDryAvgFuelDeltaText, Mode=OneWay}" />
                                        </TextBlock>
                                    </Grid>
                                </GroupBox>


                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </styles:SHTabItem>
                
                
            </TabControl>
        </DockPanel>
    </Grid>
</UserControl>
   
